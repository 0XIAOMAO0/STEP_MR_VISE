#include "main.h"
//sin cos 函数查找表 共4096个值
const int16_t sin_1[] =
{
    0,      1,      3,      4,      6,      7,      9,     10,     12,     14,     15,     17,     18,     20,     21,     23,
    25,     26,     28,     29,     31,     32,     34,     36,     37,     39,     40,     42,     43,     45,     47,     48,
    50,     51,     53,     54,     56,     58,     59,     61,     62,     64,     65,     67,     69,     70,     72,     73,
    75,     76,     78,     80,     81,     83,     84,     86,     87,     89,     90,     92,     94,     95,     97,     98,
    100,    101,    103,    105,    106,    108,    109,    111,    112,    114,    115,    117,    119,    120,    122,    123,
    125,    126,    128,    130,    131,    133,    134,    136,    137,    139,    140,    142,    144,    145,    147,    148,
    150,    151,    153,    154,    156,    158,    159,    161,    162,    164,    165,    167,    168,    170,    171,    173,
    175,    176,    178,    179,    181,    182,    184,    185,    187,    188,    190,    192,    193,    195,    196,    198,
    199,    201,    202,    204,    205,    207,    209,    210,    212,    213,    215,    216,    218,    219,    221,    222,
    224,    225,    227,    228,    230,    232,    233,    235,    236,    238,    239,    241,    242,    244,    245,    247,
    248,    250,    251,    253,    254,    256,    257,    259,    260,    262,    264,    265,    267,    268,    270,    271,
    273,    274,    276,    277,    279,    280,    282,    283,    285,    286,    288,    289,    291,    292,    294,    295,
    297,    298,    300,    301,    303,    304,    306,    307,    309,    310,    312,    313,    315,    316,    318,    319,
    321,    322,    324,    325,    327,    328,    330,    331,    333,    334,    336,    337,    339,    340,    342,    343,
    344,    346,    347,    349,    350,    352,    353,    355,    356,    358,    359,    361,    362,    364,    365,    367,
    368,    369,    371,    372,    374,    375,    377,    378,    380,    381,    383,    384,    386,    387,    388,    390,
    391,    393,    394,    396,    397,    399,    400,    402,    403,    404,    406,    407,    409,    410,    412,    413,
    414,    416,    417,    419,    420,    422,    423,    424,    426,    427,    429,    430,    432,    433,    434,    436,
    437,    439,    440,    442,    443,    444,    446,    447,    449,    450,    451,    453,    454,    456,    457,    458,
    460,    461,    463,    464,    466,    467,    468,    470,    471,    472,    474,    475,    477,    478,    479,    481,
    482,    484,    485,    486,    488,    489,    491,    492,    493,    495,    496,    497,    499,    500,    501,    503,
    504,    506,    507,    508,    510,    511,    512,    514,    515,    516,    518,    519,    521,    522,    523,    525,
    526,    527,    529,    530,    531,    533,    534,    535,    537,    538,    539,    541,    542,    543,    545,    546,
    547,    549,    550,    551,    553,    554,    555,    557,    558,    559,    561,    562,    563,    564,    566,    567,
    568,    570,    571,    572,    574,    575,    576,    578,    579,    580,    581,    583,    584,    585,    587,    588,
    589,    590,    592,    593,    594,    596,    597,    598,    599,    601,    602,    603,    604,    606,    607,    608,
    609,    611,    612,    613,    615,    616,    617,    618,    620,    621,    622,    623,    625,    626,    627,    628,
    629,    631,    632,    633,    634,    636,    637,    638,    639,    641,    642,    643,    644,    645,    647,    648,
    649,    650,    652,    653,    654,    655,    656,    658,    659,    660,    661,    662,    664,    665,    666,    667,
    668,    670,    671,    672,    673,    674,    675,    677,    678,    679,    680,    681,    683,    684,    685,    686,
    687,    688,    690,    691,    692,    693,    694,    695,    696,    698,    699,    700,    701,    702,    703,    704,
    706,    707,    708,    709,    710,    711,    712,    714,    715,    716,    717,    718,    719,    720,    721,    722,
    724,    725,    726,    727,    728,    729,    730,    731,    732,    734,    735,    736,    737,    738,    739,    740,
    741,    742,    743,    744,    745,    747,    748,    749,    750,    751,    752,    753,    754,    755,    756,    757,
    758,    759,    760,    761,    762,    763,    765,    766,    767,    768,    769,    770,    771,    772,    773,    774,
    775,    776,    777,    778,    779,    780,    781,    782,    783,    784,    785,    786,    787,    788,    789,    790,
    791,    792,    793,    794,    795,    796,    797,    798,    799,    800,    801,    802,    803,    804,    805,    806,
    807,    808,    809,    810,    811,    812,    813,    813,    814,    815,    816,    817,    818,    819,    820,    821,
    822,    823,    824,    825,    826,    827,    828,    828,    829,    830,    831,    832,    833,    834,    835,    836,
    837,    838,    839,    839,    840,    841,    842,    843,    844,    845,    846,    847,    847,    848,    849,    850,
    851,    852,    853,    854,    854,    855,    856,    857,    858,    859,    860,    860,    861,    862,    863,    864,
    865,    865,    866,    867,    868,    869,    870,    870,    871,    872,    873,    874,    875,    875,    876,    877,
    878,    879,    879,    880,    881,    882,    883,    883,    884,    885,    886,    887,    887,    888,    889,    890,
    890,    891,    892,    893,    894,    894,    895,    896,    897,    897,    898,    899,    900,    900,    901,    902,
    903,    903,    904,    905,    906,    906,    907,    908,    908,    909,    910,    911,    911,    912,    913,    913,
    914,    915,    916,    916,    917,    918,    918,    919,    920,    920,    921,    922,    922,    923,    924,    925,
    925,    926,    927,    927,    928,    929,    929,    930,    930,    931,    932,    932,    933,    934,    934,    935,
    936,    936,    937,    938,    938,    939,    939,    940,    941,    941,    942,    943,    943,    944,    944,    945,
    946,    946,    947,    947,    948,    949,    949,    950,    950,    951,    951,    952,    953,    953,    954,    954,
    955,    955,    956,    957,    957,    958,    958,    959,    959,    960,    960,    961,    962,    962,    963,    963,
    964,    964,    965,    965,    966,    966,    967,    967,    968,    968,    969,    969,    970,    970,    971,    971,
    972,    972,    973,    973,    974,    974,    975,    975,    976,    976,    977,    977,    978,    978,    978,    979,
    979,    980,    980,    981,    981,    982,    982,    983,    983,    983,    984,    984,    985,    985,    986,    986,
    986,    987,    987,    988,    988,    988,    989,    989,    990,    990,    990,    991,    991,    992,    992,    992,
    993,    993,    994,    994,    994,    995,    995,    995,    996,    996,    997,    997,    997,    998,    998,    998,
    999,    999,    999,   1000,   1000,   1000,   1001,   1001,   1001,   1002,   1002,   1002,   1003,   1003,   1003,   1004,
    1004,   1004,   1004,   1005,   1005,   1005,   1006,   1006,   1006,   1006,   1007,   1007,   1007,   1008,   1008,   1008,
    1008,   1009,   1009,   1009,   1009,   1010,   1010,   1010,   1010,   1011,   1011,   1011,   1011,   1012,   1012,   1012,
    1012,   1013,   1013,   1013,   1013,   1014,   1014,   1014,   1014,   1014,   1015,   1015,   1015,   1015,   1015,   1016,
    1016,   1016,   1016,   1016,   1017,   1017,   1017,   1017,   1017,   1017,   1018,   1018,   1018,   1018,   1018,   1018,
    1019,   1019,   1019,   1019,   1019,   1019,   1019,   1020,   1020,   1020,   1020,   1020,   1020,   1020,   1020,   1021,
    1021,   1021,   1021,   1021,   1021,   1021,   1021,   1021,   1022,   1022,   1022,   1022,   1022,   1022,   1022,   1022,
    1022,   1022,   1022,   1022,   1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,
    1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,
    1024,   1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,
    1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,   1023,   1022,   1022,   1022,
    1022,   1022,   1022,   1022,   1022,   1022,   1022,   1022,   1022,   1021,   1021,   1021,   1021,   1021,   1021,   1021,
    1021,   1021,   1020,   1020,   1020,   1020,   1020,   1020,   1020,   1020,   1019,   1019,   1019,   1019,   1019,   1019,
    1019,   1018,   1018,   1018,   1018,   1018,   1018,   1017,   1017,   1017,   1017,   1017,   1017,   1016,   1016,   1016,
    1016,   1016,   1015,   1015,   1015,   1015,   1015,   1014,   1014,   1014,   1014,   1014,   1013,   1013,   1013,   1013,
    1012,   1012,   1012,   1012,   1011,   1011,   1011,   1011,   1010,   1010,   1010,   1010,   1009,   1009,   1009,   1009,
    1008,   1008,   1008,   1008,   1007,   1007,   1007,   1006,   1006,   1006,   1006,   1005,   1005,   1005,   1004,   1004,
    1004,   1004,   1003,   1003,   1003,   1002,   1002,   1002,   1001,   1001,   1001,   1000,   1000,   1000,    999,    999,
    999,    998,    998,    998,    997,    997,    997,    996,    996,    995,    995,    995,    994,    994,    994,    993,
    993,    992,    992,    992,    991,    991,    990,    990,    990,    989,    989,    988,    988,    988,    987,    987,
    986,    986,    986,    985,    985,    984,    984,    983,    983,    983,    982,    982,    981,    981,    980,    980,
    979,    979,    978,    978,    978,    977,    977,    976,    976,    975,    975,    974,    974,    973,    973,    972,
    972,    971,    971,    970,    970,    969,    969,    968,    968,    967,    967,    966,    966,    965,    965,    964,
    964,    963,    963,    962,    962,    961,    960,    960,    959,    959,    958,    958,    957,    957,    956,    955,
    955,    954,    954,    953,    953,    952,    951,    951,    950,    950,    949,    949,    948,    947,    947,    946,
    946,    945,    944,    944,    943,    943,    942,    941,    941,    940,    939,    939,    938,    938,    937,    936,
    936,    935,    934,    934,    933,    932,    932,    931,    930,    930,    929,    929,    928,    927,    927,    926,
    925,    925,    924,    923,    922,    922,    921,    920,    920,    919,    918,    918,    917,    916,    916,    915,
    914,    913,    913,    912,    911,    911,    910,    909,    908,    908,    907,    906,    906,    905,    904,    903,
    903,    902,    901,    900,    900,    899,    898,    897,    897,    896,    895,    894,    894,    893,    892,    891,
    890,    890,    889,    888,    887,    887,    886,    885,    884,    883,    883,    882,    881,    880,    879,    879,
    878,    877,    876,    875,    875,    874,    873,    872,    871,    870,    870,    869,    868,    867,    866,    865,
    865,    864,    863,    862,    861,    860,    860,    859,    858,    857,    856,    855,    854,    854,    853,    852,
    851,    850,    849,    848,    847,    847,    846,    845,    844,    843,    842,    841,    840,    839,    839,    838,
    837,    836,    835,    834,    833,    832,    831,    830,    829,    828,    828,    827,    826,    825,    824,    823,
    822,    821,    820,    819,    818,    817,    816,    815,    814,    813,    813,    812,    811,    810,    809,    808,
    807,    806,    805,    804,    803,    802,    801,    800,    799,    798,    797,    796,    795,    794,    793,    792,
    791,    790,    789,    788,    787,    786,    785,    784,    783,    782,    781,    780,    779,    778,    777,    776,
    775,    774,    773,    772,    771,    770,    769,    768,    767,    766,    765,    763,    762,    761,    760,    759,
    758,    757,    756,    755,    754,    753,    752,    751,    750,    749,    748,    747,    745,    744,    743,    742,
    741,    740,    739,    738,    737,    736,    735,    734,    732,    731,    730,    729,    728,    727,    726,    725,
    724,    722,    721,    720,    719,    718,    717,    716,    715,    714,    712,    711,    710,    709,    708,    707,
    706,    704,    703,    702,    701,    700,    699,    698,    696,    695,    694,    693,    692,    691,    690,    688,
    687,    686,    685,    684,    683,    681,    680,    679,    678,    677,    675,    674,    673,    672,    671,    670,
    668,    667,    666,    665,    664,    662,    661,    660,    659,    658,    656,    655,    654,    653,    652,    650,
    649,    648,    647,    645,    644,    643,    642,    641,    639,    638,    637,    636,    634,    633,    632,    631,
    629,    628,    627,    626,    625,    623,    622,    621,    620,    618,    617,    616,    615,    613,    612,    611,
    609,    608,    607,    606,    604,    603,    602,    601,    599,    598,    597,    596,    594,    593,    592,    590,
    589,    588,    587,    585,    584,    583,    581,    580,    579,    578,    576,    575,    574,    572,    571,    570,
    568,    567,    566,    564,    563,    562,    561,    559,    558,    557,    555,    554,    553,    551,    550,    549,
    547,    546,    545,    543,    542,    541,    539,    538,    537,    535,    534,    533,    531,    530,    529,    527,
    526,    525,    523,    522,    521,    519,    518,    516,    515,    514,    512,    511,    510,    508,    507,    506,
    504,    503,    501,    500,    499,    497,    496,    495,    493,    492,    491,    489,    488,    486,    485,    484,
    482,    481,    479,    478,    477,    475,    474,    472,    471,    470,    468,    467,    466,    464,    463,    461,
    460,    458,    457,    456,    454,    453,    451,    450,    449,    447,    446,    444,    443,    442,    440,    439,
    437,    436,    434,    433,    432,    430,    429,    427,    426,    424,    423,    422,    420,    419,    417,    416,
    414,    413,    412,    410,    409,    407,    406,    404,    403,    402,    400,    399,    397,    396,    394,    393,
    391,    390,    388,    387,    386,    384,    383,    381,    380,    378,    377,    375,    374,    372,    371,    369,
    368,    367,    365,    364,    362,    361,    359,    358,    356,    355,    353,    352,    350,    349,    347,    346,
    344,    343,    342,    340,    339,    337,    336,    334,    333,    331,    330,    328,    327,    325,    324,    322,
    321,    319,    318,    316,    315,    313,    312,    310,    309,    307,    306,    304,    303,    301,    300,    298,
    297,    295,    294,    292,    291,    289,    288,    286,    285,    283,    282,    280,    279,    277,    276,    274,
    273,    271,    270,    268,    267,    265,    264,    262,    260,    259,    257,    256,    254,    253,    251,    250,
    248,    247,    245,    244,    242,    241,    239,    238,    236,    235,    233,    232,    230,    228,    227,    225,
    224,    222,    221,    219,    218,    216,    215,    213,    212,    210,    209,    207,    205,    204,    202,    201,
    199,    198,    196,    195,    193,    192,    190,    188,    187,    185,    184,    182,    181,    179,    178,    176,
    175,    173,    171,    170,    168,    167,    165,    164,    162,    161,    159,    158,    156,    154,    153,    151,
    150,    148,    147,    145,    144,    142,    140,    139,    137,    136,    134,    133,    131,    130,    128,    126,
    125,    123,    122,    120,    119,    117,    115,    114,    112,    111,    109,    108,    106,    105,    103,    101,
    100,     98,     97,     95,     94,     92,     90,     89,     87,     86,     84,     83,     81,     80,     78,     76,
    75,     73,     72,     70,     69,     67,     65,     64,     62,     61,     59,     58,     56,     54,     53,     51,
    50,     48,     47,     45,     43,     42,     40,     39,     37,     36,     34,     32,     31,     29,     28,     26,
    25,     23,     21,     20,     18,     17,     15,     14,     12,     10,      9,      7,      6,      4,      3,      1,
    0,     -1,     -3,     -4,     -6,     -7,     -9,    -10,    -12,    -14,    -15,    -17,    -18,    -20,    -21,    -23,
    -25,    -26,    -28,    -29,    -31,    -32,    -34,    -36,    -37,    -39,    -40,    -42,    -43,    -45,    -47,    -48,
    -50,    -51,    -53,    -54,    -56,    -58,    -59,    -61,    -62,    -64,    -65,    -67,    -69,    -70,    -72,    -73,
    -75,    -76,    -78,    -80,    -81,    -83,    -84,    -86,    -87,    -89,    -90,    -92,    -94,    -95,    -97,    -98,
    -100,   -101,   -103,   -105,   -106,   -108,   -109,   -111,   -112,   -114,   -115,   -117,   -119,   -120,   -122,   -123,
    -125,   -126,   -128,   -130,   -131,   -133,   -134,   -136,   -137,   -139,   -140,   -142,   -144,   -145,   -147,   -148,
    -150,   -151,   -153,   -154,   -156,   -158,   -159,   -161,   -162,   -164,   -165,   -167,   -168,   -170,   -171,   -173,
    -175,   -176,   -178,   -179,   -181,   -182,   -184,   -185,   -187,   -188,   -190,   -192,   -193,   -195,   -196,   -198,
    -199,   -201,   -202,   -204,   -205,   -207,   -209,   -210,   -212,   -213,   -215,   -216,   -218,   -219,   -221,   -222,
    -224,   -225,   -227,   -228,   -230,   -232,   -233,   -235,   -236,   -238,   -239,   -241,   -242,   -244,   -245,   -247,
    -248,   -250,   -251,   -253,   -254,   -256,   -257,   -259,   -260,   -262,   -264,   -265,   -267,   -268,   -270,   -271,
    -273,   -274,   -276,   -277,   -279,   -280,   -282,   -283,   -285,   -286,   -288,   -289,   -291,   -292,   -294,   -295,
    -297,   -298,   -300,   -301,   -303,   -304,   -306,   -307,   -309,   -310,   -312,   -313,   -315,   -316,   -318,   -319,
    -321,   -322,   -324,   -325,   -327,   -328,   -330,   -331,   -333,   -334,   -336,   -337,   -339,   -340,   -342,   -343,
    -344,   -346,   -347,   -349,   -350,   -352,   -353,   -355,   -356,   -358,   -359,   -361,   -362,   -364,   -365,   -367,
    -368,   -369,   -371,   -372,   -374,   -375,   -377,   -378,   -380,   -381,   -383,   -384,   -386,   -387,   -388,   -390,
    -391,   -393,   -394,   -396,   -397,   -399,   -400,   -402,   -403,   -404,   -406,   -407,   -409,   -410,   -412,   -413,
    -414,   -416,   -417,   -419,   -420,   -422,   -423,   -424,   -426,   -427,   -429,   -430,   -432,   -433,   -434,   -436,
    -437,   -439,   -440,   -442,   -443,   -444,   -446,   -447,   -449,   -450,   -451,   -453,   -454,   -456,   -457,   -458,
    -460,   -461,   -463,   -464,   -466,   -467,   -468,   -470,   -471,   -472,   -474,   -475,   -477,   -478,   -479,   -481,
    -482,   -484,   -485,   -486,   -488,   -489,   -491,   -492,   -493,   -495,   -496,   -497,   -499,   -500,   -501,   -503,
    -504,   -506,   -507,   -508,   -510,   -511,   -512,   -514,   -515,   -516,   -518,   -519,   -521,   -522,   -523,   -525,
    -526,   -527,   -529,   -530,   -531,   -533,   -534,   -535,   -537,   -538,   -539,   -541,   -542,   -543,   -545,   -546,
    -547,   -549,   -550,   -551,   -553,   -554,   -555,   -557,   -558,   -559,   -561,   -562,   -563,   -564,   -566,   -567,
    -568,   -570,   -571,   -572,   -574,   -575,   -576,   -578,   -579,   -580,   -581,   -583,   -584,   -585,   -587,   -588,
    -589,   -590,   -592,   -593,   -594,   -596,   -597,   -598,   -599,   -601,   -602,   -603,   -604,   -606,   -607,   -608,
    -609,   -611,   -612,   -613,   -615,   -616,   -617,   -618,   -620,   -621,   -622,   -623,   -625,   -626,   -627,   -628,
    -629,   -631,   -632,   -633,   -634,   -636,   -637,   -638,   -639,   -641,   -642,   -643,   -644,   -645,   -647,   -648,
    -649,   -650,   -652,   -653,   -654,   -655,   -656,   -658,   -659,   -660,   -661,   -662,   -664,   -665,   -666,   -667,
    -668,   -670,   -671,   -672,   -673,   -674,   -675,   -677,   -678,   -679,   -680,   -681,   -683,   -684,   -685,   -686,
    -687,   -688,   -690,   -691,   -692,   -693,   -694,   -695,   -696,   -698,   -699,   -700,   -701,   -702,   -703,   -704,
    -706,   -707,   -708,   -709,   -710,   -711,   -712,   -714,   -715,   -716,   -717,   -718,   -719,   -720,   -721,   -722,
    -724,   -725,   -726,   -727,   -728,   -729,   -730,   -731,   -732,   -734,   -735,   -736,   -737,   -738,   -739,   -740,
    -741,   -742,   -743,   -744,   -745,   -747,   -748,   -749,   -750,   -751,   -752,   -753,   -754,   -755,   -756,   -757,
    -758,   -759,   -760,   -761,   -762,   -763,   -765,   -766,   -767,   -768,   -769,   -770,   -771,   -772,   -773,   -774,
    -775,   -776,   -777,   -778,   -779,   -780,   -781,   -782,   -783,   -784,   -785,   -786,   -787,   -788,   -789,   -790,
    -791,   -792,   -793,   -794,   -795,   -796,   -797,   -798,   -799,   -800,   -801,   -802,   -803,   -804,   -805,   -806,
    -807,   -808,   -809,   -810,   -811,   -812,   -813,   -813,   -814,   -815,   -816,   -817,   -818,   -819,   -820,   -821,
    -822,   -823,   -824,   -825,   -826,   -827,   -828,   -828,   -829,   -830,   -831,   -832,   -833,   -834,   -835,   -836,
    -837,   -838,   -839,   -839,   -840,   -841,   -842,   -843,   -844,   -845,   -846,   -847,   -847,   -848,   -849,   -850,
    -851,   -852,   -853,   -854,   -854,   -855,   -856,   -857,   -858,   -859,   -860,   -860,   -861,   -862,   -863,   -864,
    -865,   -865,   -866,   -867,   -868,   -869,   -870,   -870,   -871,   -872,   -873,   -874,   -875,   -875,   -876,   -877,
    -878,   -879,   -879,   -880,   -881,   -882,   -883,   -883,   -884,   -885,   -886,   -887,   -887,   -888,   -889,   -890,
    -890,   -891,   -892,   -893,   -894,   -894,   -895,   -896,   -897,   -897,   -898,   -899,   -900,   -900,   -901,   -902,
    -903,   -903,   -904,   -905,   -906,   -906,   -907,   -908,   -908,   -909,   -910,   -911,   -911,   -912,   -913,   -913,
    -914,   -915,   -916,   -916,   -917,   -918,   -918,   -919,   -920,   -920,   -921,   -922,   -922,   -923,   -924,   -925,
    -925,   -926,   -927,   -927,   -928,   -929,   -929,   -930,   -930,   -931,   -932,   -932,   -933,   -934,   -934,   -935,
    -936,   -936,   -937,   -938,   -938,   -939,   -939,   -940,   -941,   -941,   -942,   -943,   -943,   -944,   -944,   -945,
    -946,   -946,   -947,   -947,   -948,   -949,   -949,   -950,   -950,   -951,   -951,   -952,   -953,   -953,   -954,   -954,
    -955,   -955,   -956,   -957,   -957,   -958,   -958,   -959,   -959,   -960,   -960,   -961,   -962,   -962,   -963,   -963,
    -964,   -964,   -965,   -965,   -966,   -966,   -967,   -967,   -968,   -968,   -969,   -969,   -970,   -970,   -971,   -971,
    -972,   -972,   -973,   -973,   -974,   -974,   -975,   -975,   -976,   -976,   -977,   -977,   -978,   -978,   -978,   -979,
    -979,   -980,   -980,   -981,   -981,   -982,   -982,   -983,   -983,   -983,   -984,   -984,   -985,   -985,   -986,   -986,
    -986,   -987,   -987,   -988,   -988,   -988,   -989,   -989,   -990,   -990,   -990,   -991,   -991,   -992,   -992,   -992,
    -993,   -993,   -994,   -994,   -994,   -995,   -995,   -995,   -996,   -996,   -997,   -997,   -997,   -998,   -998,   -998,
    -999,   -999,   -999,  -1000,  -1000,  -1000,  -1001,  -1001,  -1001,  -1002,  -1002,  -1002,  -1003,  -1003,  -1003,  -1004,
    -1004,  -1004,  -1004,  -1005,  -1005,  -1005,  -1006,  -1006,  -1006,  -1006,  -1007,  -1007,  -1007,  -1008,  -1008,  -1008,
    -1008,  -1009,  -1009,  -1009,  -1009,  -1010,  -1010,  -1010,  -1010,  -1011,  -1011,  -1011,  -1011,  -1012,  -1012,  -1012,
    -1012,  -1013,  -1013,  -1013,  -1013,  -1014,  -1014,  -1014,  -1014,  -1014,  -1015,  -1015,  -1015,  -1015,  -1015,  -1016,
    -1016,  -1016,  -1016,  -1016,  -1017,  -1017,  -1017,  -1017,  -1017,  -1017,  -1018,  -1018,  -1018,  -1018,  -1018,  -1018,
    -1019,  -1019,  -1019,  -1019,  -1019,  -1019,  -1019,  -1020,  -1020,  -1020,  -1020,  -1020,  -1020,  -1020,  -1020,  -1021,
    -1021,  -1021,  -1021,  -1021,  -1021,  -1021,  -1021,  -1021,  -1022,  -1022,  -1022,  -1022,  -1022,  -1022,  -1022,  -1022,
    -1022,  -1022,  -1022,  -1022,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,
    -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,
    -1024,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,
    -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1023,  -1022,  -1022,  -1022,
    -1022,  -1022,  -1022,  -1022,  -1022,  -1022,  -1022,  -1022,  -1022,  -1021,  -1021,  -1021,  -1021,  -1021,  -1021,  -1021,
    -1021,  -1021,  -1020,  -1020,  -1020,  -1020,  -1020,  -1020,  -1020,  -1020,  -1019,  -1019,  -1019,  -1019,  -1019,  -1019,
    -1019,  -1018,  -1018,  -1018,  -1018,  -1018,  -1018,  -1017,  -1017,  -1017,  -1017,  -1017,  -1017,  -1016,  -1016,  -1016,
    -1016,  -1016,  -1015,  -1015,  -1015,  -1015,  -1015,  -1014,  -1014,  -1014,  -1014,  -1014,  -1013,  -1013,  -1013,  -1013,
    -1012,  -1012,  -1012,  -1012,  -1011,  -1011,  -1011,  -1011,  -1010,  -1010,  -1010,  -1010,  -1009,  -1009,  -1009,  -1009,
    -1008,  -1008,  -1008,  -1008,  -1007,  -1007,  -1007,  -1006,  -1006,  -1006,  -1006,  -1005,  -1005,  -1005,  -1004,  -1004,
    -1004,  -1004,  -1003,  -1003,  -1003,  -1002,  -1002,  -1002,  -1001,  -1001,  -1001,  -1000,  -1000,  -1000,   -999,   -999,
    -999,   -998,   -998,   -998,   -997,   -997,   -997,   -996,   -996,   -995,   -995,   -995,   -994,   -994,   -994,   -993,
    -993,   -992,   -992,   -992,   -991,   -991,   -990,   -990,   -990,   -989,   -989,   -988,   -988,   -988,   -987,   -987,
    -986,   -986,   -986,   -985,   -985,   -984,   -984,   -983,   -983,   -983,   -982,   -982,   -981,   -981,   -980,   -980,
    -979,   -979,   -978,   -978,   -978,   -977,   -977,   -976,   -976,   -975,   -975,   -974,   -974,   -973,   -973,   -972,
    -972,   -971,   -971,   -970,   -970,   -969,   -969,   -968,   -968,   -967,   -967,   -966,   -966,   -965,   -965,   -964,
    -964,   -963,   -963,   -962,   -962,   -961,   -960,   -960,   -959,   -959,   -958,   -958,   -957,   -957,   -956,   -955,
    -955,   -954,   -954,   -953,   -953,   -952,   -951,   -951,   -950,   -950,   -949,   -949,   -948,   -947,   -947,   -946,
    -946,   -945,   -944,   -944,   -943,   -943,   -942,   -941,   -941,   -940,   -939,   -939,   -938,   -938,   -937,   -936,
    -936,   -935,   -934,   -934,   -933,   -932,   -932,   -931,   -930,   -930,   -929,   -929,   -928,   -927,   -927,   -926,
    -925,   -925,   -924,   -923,   -922,   -922,   -921,   -920,   -920,   -919,   -918,   -918,   -917,   -916,   -916,   -915,
    -914,   -913,   -913,   -912,   -911,   -911,   -910,   -909,   -908,   -908,   -907,   -906,   -906,   -905,   -904,   -903,
    -903,   -902,   -901,   -900,   -900,   -899,   -898,   -897,   -897,   -896,   -895,   -894,   -894,   -893,   -892,   -891,
    -890,   -890,   -889,   -888,   -887,   -887,   -886,   -885,   -884,   -883,   -883,   -882,   -881,   -880,   -879,   -879,
    -878,   -877,   -876,   -875,   -875,   -874,   -873,   -872,   -871,   -870,   -870,   -869,   -868,   -867,   -866,   -865,
    -865,   -864,   -863,   -862,   -861,   -860,   -860,   -859,   -858,   -857,   -856,   -855,   -854,   -854,   -853,   -852,
    -851,   -850,   -849,   -848,   -847,   -847,   -846,   -845,   -844,   -843,   -842,   -841,   -840,   -839,   -839,   -838,
    -837,   -836,   -835,   -834,   -833,   -832,   -831,   -830,   -829,   -828,   -828,   -827,   -826,   -825,   -824,   -823,
    -822,   -821,   -820,   -819,   -818,   -817,   -816,   -815,   -814,   -813,   -813,   -812,   -811,   -810,   -809,   -808,
    -807,   -806,   -805,   -804,   -803,   -802,   -801,   -800,   -799,   -798,   -797,   -796,   -795,   -794,   -793,   -792,
    -791,   -790,   -789,   -788,   -787,   -786,   -785,   -784,   -783,   -782,   -781,   -780,   -779,   -778,   -777,   -776,
    -775,   -774,   -773,   -772,   -771,   -770,   -769,   -768,   -767,   -766,   -765,   -763,   -762,   -761,   -760,   -759,
    -758,   -757,   -756,   -755,   -754,   -753,   -752,   -751,   -750,   -749,   -748,   -747,   -745,   -744,   -743,   -742,
    -741,   -740,   -739,   -738,   -737,   -736,   -735,   -734,   -732,   -731,   -730,   -729,   -728,   -727,   -726,   -725,
    -724,   -722,   -721,   -720,   -719,   -718,   -717,   -716,   -715,   -714,   -712,   -711,   -710,   -709,   -708,   -707,
    -706,   -704,   -703,   -702,   -701,   -700,   -699,   -698,   -696,   -695,   -694,   -693,   -692,   -691,   -690,   -688,
    -687,   -686,   -685,   -684,   -683,   -681,   -680,   -679,   -678,   -677,   -675,   -674,   -673,   -672,   -671,   -670,
    -668,   -667,   -666,   -665,   -664,   -662,   -661,   -660,   -659,   -658,   -656,   -655,   -654,   -653,   -652,   -650,
    -649,   -648,   -647,   -645,   -644,   -643,   -642,   -641,   -639,   -638,   -637,   -636,   -634,   -633,   -632,   -631,
    -629,   -628,   -627,   -626,   -625,   -623,   -622,   -621,   -620,   -618,   -617,   -616,   -615,   -613,   -612,   -611,
    -609,   -608,   -607,   -606,   -604,   -603,   -602,   -601,   -599,   -598,   -597,   -596,   -594,   -593,   -592,   -590,
    -589,   -588,   -587,   -585,   -584,   -583,   -581,   -580,   -579,   -578,   -576,   -575,   -574,   -572,   -571,   -570,
    -568,   -567,   -566,   -564,   -563,   -562,   -561,   -559,   -558,   -557,   -555,   -554,   -553,   -551,   -550,   -549,
    -547,   -546,   -545,   -543,   -542,   -541,   -539,   -538,   -537,   -535,   -534,   -533,   -531,   -530,   -529,   -527,
    -526,   -525,   -523,   -522,   -521,   -519,   -518,   -516,   -515,   -514,   -512,   -511,   -510,   -508,   -507,   -506,
    -504,   -503,   -501,   -500,   -499,   -497,   -496,   -495,   -493,   -492,   -491,   -489,   -488,   -486,   -485,   -484,
    -482,   -481,   -479,   -478,   -477,   -475,   -474,   -472,   -471,   -470,   -468,   -467,   -466,   -464,   -463,   -461,
    -460,   -458,   -457,   -456,   -454,   -453,   -451,   -450,   -449,   -447,   -446,   -444,   -443,   -442,   -440,   -439,
    -437,   -436,   -434,   -433,   -432,   -430,   -429,   -427,   -426,   -424,   -423,   -422,   -420,   -419,   -417,   -416,
    -414,   -413,   -412,   -410,   -409,   -407,   -406,   -404,   -403,   -402,   -400,   -399,   -397,   -396,   -394,   -393,
    -391,   -390,   -388,   -387,   -386,   -384,   -383,   -381,   -380,   -378,   -377,   -375,   -374,   -372,   -371,   -369,
    -368,   -367,   -365,   -364,   -362,   -361,   -359,   -358,   -356,   -355,   -353,   -352,   -350,   -349,   -347,   -346,
    -344,   -343,   -342,   -340,   -339,   -337,   -336,   -334,   -333,   -331,   -330,   -328,   -327,   -325,   -324,   -322,
    -321,   -319,   -318,   -316,   -315,   -313,   -312,   -310,   -309,   -307,   -306,   -304,   -303,   -301,   -300,   -298,
    -297,   -295,   -294,   -292,   -291,   -289,   -288,   -286,   -285,   -283,   -282,   -280,   -279,   -277,   -276,   -274,
    -273,   -271,   -270,   -268,   -267,   -265,   -264,   -262,   -260,   -259,   -257,   -256,   -254,   -253,   -251,   -250,
    -248,   -247,   -245,   -244,   -242,   -241,   -239,   -238,   -236,   -235,   -233,   -232,   -230,   -228,   -227,   -225,
    -224,   -222,   -221,   -219,   -218,   -216,   -215,   -213,   -212,   -210,   -209,   -207,   -205,   -204,   -202,   -201,
    -199,   -198,   -196,   -195,   -193,   -192,   -190,   -188,   -187,   -185,   -184,   -182,   -181,   -179,   -178,   -176,
    -175,   -173,   -171,   -170,   -168,   -167,   -165,   -164,   -162,   -161,   -159,   -158,   -156,   -154,   -153,   -151,
    -150,   -148,   -147,   -145,   -144,   -142,   -140,   -139,   -137,   -136,   -134,   -133,   -131,   -130,   -128,   -126,
    -125,   -123,   -122,   -120,   -119,   -117,   -115,   -114,   -112,   -111,   -109,   -108,   -106,   -105,   -103,   -101,
    -100,    -98,    -97,    -95,    -94,    -92,    -90,    -89,    -87,    -86,    -84,    -83,    -81,    -80,    -78,    -76,
    -75,    -73,    -72,    -70,    -69,    -67,    -65,    -64,    -62,    -61,    -59,    -58,    -56,    -54,    -53,    -51,
    -50,    -48,    -47,    -45,    -43,    -42,    -40,    -39,    -37,    -36,    -34,    -32,    -31,    -29,    -28,    -26,
    -25,    -23,    -21,    -20,    -18,    -17,    -15,    -14,    -12,    -10,     -9,     -7,     -6,     -4,     -3,     -1,
    0,
};

static void LL_Init(void);
void SystemClock_Config(void);
static void MX_GPIO_Init(void);
static void MX_SPI1_Init(void);
static void MX_TIM1_Init(void);
static void MX_TIM3_Init(void);
static void MX_TIM6_Init(void);
static void MX_IWDG_Init(void);
static void MX_USART1_UART_Init(void);

void SetModeCheck(void);
void UsDelay(uint16_t us);
void Output(int32_t theta, uint8_t effort);
int16_t Mod(int32_t xMod, int16_t mMod);
void OneStep(void);
void FlashUnlock(void);
void FlashLock(void);
uint8_t FlashGetStatus(void);
uint8_t FlashWaitDone(uint16_t time);
uint8_t FlashErasePage(uint32_t paddr);
void FlashErase32K(void);
uint8_t FlashWriteHalfWord(uint32_t faddr, uint16_t dat);
uint16_t FlashReadHalfWord(uint32_t faddr);
int fputc(int c, FILE * stream);
int fgetc(FILE * stream);
void SerialCheck(void);
void CalibrateEncoder(void);

uint16_t ReadValue(uint16_t RegValue);
void WriteValue(uint16_t RegAdd,uint16_t RegValue);
uint16_t ReadState(void);
uint16_t ReadAngle(void);
void TLE5012_Init(void);
void OneStep_4096(void);
void test_4096(void);


//PID参数变量
//int16_t kp=30;
//int16_t ki=10;
//int16_t kd=100;
// 已移植
int16_t kp = 60;
int16_t ki = 5;
int16_t kd = 80;

int32_t step_input = 0; //外部控制脉冲输入定时器的值
int32_t step_input_last = 0;
int32_t step_input_sum = 0; //外部控制脉冲输入累计值
int32_t motor_pos_set = 0; //指令电机位置
int32_t motor_pos_set_last = 0;
uint8_t dir = 1; //电机旋转方向
int16_t encoder_cnt = 0; //编码器的读数值
int16_t encoder_cnt_last = 0;
int32_t motor_pos = 0; //实际电机位置值
int32_t motor_pos_last = 0;
int32_t advance = 0; //电机控制提前角度
int32_t motor_rev_cnt = 0; //电机旋转圈数
int32_t motor_pos_err = 0; //误差值等于指令电机位置值减去实际电机位置值
int32_t pid_iterm = 0; //PID控制i积分项
int32_t pid_dterm = 0; //PID控制d微分项
int32_t vector_current = 0; //矢量控制电流大小
int32_t stepnumber = 0; //电机走的整步步数
float stepangle = 0.0f; //电子齿轮值

uint16_t half_current_cnt = 0; //开环模式下半流控制计数值
uint8_t closedloop_mode;//开环闭环模式标志位
uint8_t en_mode = 1; //使能标志位

int main(void)
{
		uint16_t angle;
    LL_Init();
    SystemClock_Config();
    MX_GPIO_Init();
    MX_SPI1_Init();
    MX_TIM3_Init();
    MX_USART1_UART_Init();
    MX_TIM1_Init();
		TLE5012_Init();	
    LL_mDelay(100);
    SetModeCheck();
    MX_TIM6_Init();
    MX_IWDG_Init();
    while(1)
    {
        SerialCheck();
//			angle=ReadAngle();
//			printf("angle:%d\n",angle);
    }
}

static void LL_Init(void)
{
    LL_APB1_GRP2_EnableClock(LL_APB1_GRP2_PERIPH_SYSCFG);
    NVIC_SetPriority(SVC_IRQn, 0);
    NVIC_SetPriority(PendSV_IRQn, 0);
    NVIC_SetPriority(SysTick_IRQn, 0);
}

void TLE5012_Init(void)
{
	uint16_t state,angle;
	WriteValue(WRITE_MOD2_VALUE,MOD2_VALUE);
	state=ReadState();
	angle=ReadAngle();
	printf("state:%d,angle:%d\n",state,angle);
	
}

void SystemClock_Config(void)
{
  LL_FLASH_SetLatency(LL_FLASH_LATENCY_1);
	
  if(LL_FLASH_GetLatency() != LL_FLASH_LATENCY_1)
  {
    Error_Handler();  
  }
  LL_RCC_HSI_Enable();
  
  while(LL_RCC_HSI_IsReady() != 1)
  {}
  LL_RCC_HSI_SetCalibTrimming(16);
  LL_RCC_LSI_Enable();
  while(LL_RCC_LSI_IsReady() != 1)
  {}
  LL_RCC_PLL_ConfigDomain_SYS(LL_RCC_PLLSOURCE_HSI_DIV_2, LL_RCC_PLL_MUL_12);
  LL_RCC_PLL_Enable();
	  
  while(LL_RCC_PLL_IsReady() != 1)
  {}
  LL_RCC_SetAHBPrescaler(LL_RCC_SYSCLK_DIV_1);
  LL_RCC_SetAPB1Prescaler(LL_RCC_APB1_DIV_1);
  LL_RCC_SetSysClkSource(LL_RCC_SYS_CLKSOURCE_PLL);
	  
  while(LL_RCC_GetSysClkSource() != LL_RCC_SYS_CLKSOURCE_STATUS_PLL)
  {}
  LL_Init1msTick(48000000);
  LL_SYSTICK_SetClkSource(LL_SYSTICK_CLKSOURCE_HCLK);
  LL_SetSystemCoreClock(48000000);
  LL_RCC_SetUSARTClockSource(LL_RCC_USART1_CLKSOURCE_PCLK1);
  NVIC_SetPriority(SysTick_IRQn, 0);
}

static void MX_IWDG_Init(void)
{
    LL_IWDG_Enable(IWDG);
    LL_IWDG_EnableWriteAccess(IWDG);
    LL_IWDG_SetPrescaler(IWDG, LL_IWDG_PRESCALER_4);
    LL_IWDG_SetWindow(IWDG, 4095);
    LL_IWDG_SetReloadCounter(IWDG, 500);
    while(LL_IWDG_IsReady(IWDG) != 1)
    {}
    LL_IWDG_ReloadCounter(IWDG);
}
//SPI初始化函数，用于和MT6816传输数据
static void MX_SPI1_Init(void)
{
    LL_SPI_InitTypeDef SPI_InitStruct;
    LL_GPIO_InitTypeDef GPIO_InitStruct;
    LL_APB1_GRP2_EnableClock(LL_APB1_GRP2_PERIPH_SPI1);
    /** SPI1 GPIO Configuration
        PA4   ------> SPI1_NSS
        PA5   ------> SPI1_SCK
        PA6   ------> SPI1_MISO
        PA7   ------> SPI1_MOSI
    */
    GPIO_InitStruct.Pin = LL_GPIO_PIN_5;
    GPIO_InitStruct.Mode = LL_GPIO_MODE_ALTERNATE;
    GPIO_InitStruct.Speed = LL_GPIO_SPEED_FREQ_HIGH;
    GPIO_InitStruct.OutputType = LL_GPIO_OUTPUT_PUSHPULL;
    GPIO_InitStruct.Pull = LL_GPIO_PULL_DOWN;
    GPIO_InitStruct.Alternate = LL_GPIO_AF_0;
    LL_GPIO_Init(GPIOA, &GPIO_InitStruct);
    GPIO_InitStruct.Pin = LL_GPIO_PIN_6;
    GPIO_InitStruct.Mode = LL_GPIO_MODE_ALTERNATE;
    GPIO_InitStruct.Speed = LL_GPIO_SPEED_FREQ_HIGH;
    GPIO_InitStruct.OutputType = LL_GPIO_OUTPUT_PUSHPULL;
    GPIO_InitStruct.Pull = LL_GPIO_PULL_DOWN;
    GPIO_InitStruct.Alternate = LL_GPIO_AF_0;
    LL_GPIO_Init(GPIOA, &GPIO_InitStruct);
    GPIO_InitStruct.Pin = LL_GPIO_PIN_7;
    GPIO_InitStruct.Mode = LL_GPIO_MODE_ALTERNATE;
    GPIO_InitStruct.Speed = LL_GPIO_SPEED_FREQ_HIGH;
    GPIO_InitStruct.OutputType = LL_GPIO_OUTPUT_PUSHPULL;
    GPIO_InitStruct.Pull = LL_GPIO_PULL_DOWN;
    GPIO_InitStruct.Alternate = LL_GPIO_AF_0;
    LL_GPIO_Init(GPIOA, &GPIO_InitStruct);
    SPI_InitStruct.TransferDirection = LL_SPI_FULL_DUPLEX;
    SPI_InitStruct.Mode = LL_SPI_MODE_MASTER;
    SPI_InitStruct.DataWidth = LL_SPI_DATAWIDTH_16BIT;
    SPI_InitStruct.ClockPolarity = LL_SPI_POLARITY_LOW;
    SPI_InitStruct.ClockPhase = LL_SPI_PHASE_2EDGE;
    SPI_InitStruct.NSS = LL_SPI_NSS_SOFT;
    SPI_InitStruct.BaudRate = LL_SPI_BAUDRATEPRESCALER_DIV4;
    SPI_InitStruct.BitOrder = LL_SPI_MSB_FIRST;
    SPI_InitStruct.CRCCalculation = LL_SPI_CRCCALCULATION_DISABLE;
    SPI_InitStruct.CRCPoly = 7;
    LL_SPI_Init(SPI1, &SPI_InitStruct);
    LL_SPI_SetStandard(SPI1, LL_SPI_PROTOCOL_MOTOROLA);
    LL_SPI_Enable(SPI1);
}
//定时器1工作在外部计数器模式，用于对外部控制脉冲进行计数
static void MX_TIM1_Init(void)
{
    LL_TIM_InitTypeDef TIM_InitStruct = {0};
    LL_GPIO_InitTypeDef GPIO_InitStruct = {0};
    /* Peripheral clock enable */
    LL_APB1_GRP2_EnableClock(LL_APB1_GRP2_PERIPH_TIM1);
    LL_AHB1_GRP1_EnableClock(LL_AHB1_GRP1_PERIPH_GPIOA);
    /** TIM1 GPIO Configuration
        PA12   ------> TIM1_ETR
    */
    GPIO_InitStruct.Pin = LL_GPIO_PIN_12;
    GPIO_InitStruct.Mode = LL_GPIO_MODE_ALTERNATE;
    GPIO_InitStruct.Speed = LL_GPIO_SPEED_FREQ_HIGH;
    GPIO_InitStruct.OutputType = LL_GPIO_OUTPUT_PUSHPULL;
    GPIO_InitStruct.Pull = LL_GPIO_PULL_NO;
    GPIO_InitStruct.Alternate = LL_GPIO_AF_2;
    LL_GPIO_Init(GPIOA, &GPIO_InitStruct);
    TIM_InitStruct.Prescaler = 0;
    TIM_InitStruct.CounterMode = LL_TIM_COUNTERMODE_UP;
    TIM_InitStruct.Autoreload = STEP_INPUT_COUNTER_RELOAD_VAL;
    TIM_InitStruct.ClockDivision = LL_TIM_CLOCKDIVISION_DIV1;
    TIM_InitStruct.RepetitionCounter = 0;
    LL_TIM_Init(TIM1, &TIM_InitStruct);
    LL_TIM_DisableARRPreload(TIM1);
    LL_TIM_ConfigETR(TIM1, LL_TIM_ETR_POLARITY_NONINVERTED, LL_TIM_ETR_PRESCALER_DIV1, LL_TIM_ETR_FILTER_FDIV8_N6);
    LL_TIM_SetClockSource(TIM1, LL_TIM_CLOCKSOURCE_EXT_MODE2);
    LL_TIM_SetTriggerOutput(TIM1, LL_TIM_TRGO_RESET);
    LL_TIM_DisableMasterSlaveMode(TIM1);
    LL_TIM_SetCounter(TIM1, 0);
    LL_TIM_EnableCounter(TIM1);
}
//定时器3用于生成控制A4950芯片的两个通道的PWM波，通过RC低通滤波送入A4950电压参考脚
static void MX_TIM3_Init(void)
{
    LL_TIM_InitTypeDef TIM_InitStruct;
    LL_TIM_OC_InitTypeDef TIM_OC_InitStruct;
    LL_GPIO_InitTypeDef GPIO_InitStruct;
    LL_APB1_GRP1_EnableClock(LL_APB1_GRP1_PERIPH_TIM3);
    /** TIM3 GPIO Configuration
        PB4   ------> TIM3_CH1
        PB5   ------> TIM3_CH2
    */
    GPIO_InitStruct.Pin = PWM1_Pin;
    GPIO_InitStruct.Mode = LL_GPIO_MODE_ALTERNATE;
    GPIO_InitStruct.Speed = LL_GPIO_SPEED_FREQ_HIGH;
    GPIO_InitStruct.OutputType = LL_GPIO_OUTPUT_PUSHPULL;
    GPIO_InitStruct.Pull = LL_GPIO_PULL_NO;
    GPIO_InitStruct.Alternate = LL_GPIO_AF_1;
    LL_GPIO_Init(PWM1_GPIO_Port, &GPIO_InitStruct);
    GPIO_InitStruct.Pin = PWM2_Pin;
    GPIO_InitStruct.Mode = LL_GPIO_MODE_ALTERNATE;
    GPIO_InitStruct.Speed = LL_GPIO_SPEED_FREQ_HIGH;
    GPIO_InitStruct.OutputType = LL_GPIO_OUTPUT_PUSHPULL;
    GPIO_InitStruct.Pull = LL_GPIO_PULL_NO;
    GPIO_InitStruct.Alternate = LL_GPIO_AF_1;
    LL_GPIO_Init(PWM2_GPIO_Port, &GPIO_InitStruct);
    TIM_InitStruct.Prescaler = 0;
    TIM_InitStruct.CounterMode = LL_TIM_COUNTERMODE_UP;
    TIM_InitStruct.Autoreload = 320;//200khz的pwm频率
    TIM_InitStruct.ClockDivision = LL_TIM_CLOCKDIVISION_DIV1;
    LL_TIM_Init(TIM3, &TIM_InitStruct);
    LL_TIM_DisableARRPreload(TIM3);
    LL_TIM_SetClockSource(TIM3, LL_TIM_CLOCKSOURCE_INTERNAL);
    LL_TIM_OC_EnablePreload(TIM3, LL_TIM_CHANNEL_CH1);
    TIM_OC_InitStruct.OCMode = LL_TIM_OCMODE_PWM1;
    TIM_OC_InitStruct.OCState = LL_TIM_OCSTATE_DISABLE;
    TIM_OC_InitStruct.OCNState = LL_TIM_OCSTATE_DISABLE;
    TIM_OC_InitStruct.CompareValue = 0;
    TIM_OC_InitStruct.OCPolarity = LL_TIM_OCPOLARITY_HIGH;
    LL_TIM_OC_Init(TIM3, LL_TIM_CHANNEL_CH1, &TIM_OC_InitStruct);
    LL_TIM_OC_DisableFast(TIM3, LL_TIM_CHANNEL_CH1);
    LL_TIM_OC_EnablePreload(TIM3, LL_TIM_CHANNEL_CH2);
    TIM_OC_InitStruct.OCState = LL_TIM_OCSTATE_DISABLE;
    TIM_OC_InitStruct.OCNState = LL_TIM_OCSTATE_DISABLE;
    LL_TIM_OC_Init(TIM3, LL_TIM_CHANNEL_CH2, &TIM_OC_InitStruct);
    LL_TIM_OC_DisableFast(TIM3, LL_TIM_CHANNEL_CH2);
    LL_TIM_SetTriggerOutput(TIM3, LL_TIM_TRGO_RESET);
    LL_TIM_DisableMasterSlaveMode(TIM3);
    LL_TIM_CC_EnableChannel(TIM3, LL_TIM_CHANNEL_CH1);
    LL_TIM_CC_EnableChannel(TIM3, LL_TIM_CHANNEL_CH2);
    LL_TIM_EnableCounter(TIM3);
}
//定时器6用于生成位置环控制周期
static void MX_TIM6_Init(void)
{
    LL_TIM_InitTypeDef TIM_InitStruct;
    LL_APB1_GRP1_EnableClock(LL_APB1_GRP1_PERIPH_TIM6);
    NVIC_SetPriority(TIM6_IRQn, 1);
    NVIC_EnableIRQ(TIM6_IRQn);
    TIM_InitStruct.Prescaler = 0;
    TIM_InitStruct.CounterMode = LL_TIM_COUNTERMODE_UP;
    TIM_InitStruct.Autoreload = 3200;//20khz的溢出中断频率
    LL_TIM_Init(TIM6, &TIM_InitStruct);
    LL_TIM_DisableARRPreload(TIM6);
    LL_TIM_EnableIT_UPDATE(TIM6);
    LL_TIM_EnableCounter(TIM6);
}

static void MX_USART1_UART_Init(void)
{
  LL_USART_InitTypeDef USART_InitStruct;
  LL_GPIO_InitTypeDef GPIO_InitStruct;
  LL_APB1_GRP2_EnableClock(LL_APB1_GRP2_PERIPH_USART1);
  
  /**USART1 GPIO Configuration  
  PA9   ------> USART1_TX
  PA10   ------> USART1_RX 
  */
  GPIO_InitStruct.Pin = LL_GPIO_PIN_9;
  GPIO_InitStruct.Mode = LL_GPIO_MODE_ALTERNATE;
  GPIO_InitStruct.Speed = LL_GPIO_SPEED_FREQ_HIGH;
  GPIO_InitStruct.OutputType = LL_GPIO_OUTPUT_PUSHPULL;
  GPIO_InitStruct.Pull = LL_GPIO_PULL_NO;
  GPIO_InitStruct.Alternate = LL_GPIO_AF_1;
  LL_GPIO_Init(GPIOA, &GPIO_InitStruct);

  GPIO_InitStruct.Pin = LL_GPIO_PIN_10;
  GPIO_InitStruct.Mode = LL_GPIO_MODE_ALTERNATE;
  GPIO_InitStruct.Speed = LL_GPIO_SPEED_FREQ_HIGH;
  GPIO_InitStruct.OutputType = LL_GPIO_OUTPUT_PUSHPULL;
  GPIO_InitStruct.Pull = LL_GPIO_PULL_NO;
  GPIO_InitStruct.Alternate = LL_GPIO_AF_1;
  LL_GPIO_Init(GPIOA, &GPIO_InitStruct);

  USART_InitStruct.BaudRate = 38400;
  USART_InitStruct.DataWidth = LL_USART_DATAWIDTH_8B;
  USART_InitStruct.StopBits = LL_USART_STOPBITS_1;
  USART_InitStruct.Parity = LL_USART_PARITY_NONE;
  USART_InitStruct.TransferDirection = LL_USART_DIRECTION_TX_RX;
  USART_InitStruct.HardwareFlowControl = LL_USART_HWCONTROL_NONE;
  USART_InitStruct.OverSampling = LL_USART_OVERSAMPLING_16;
  LL_USART_Init(USART1, &USART_InitStruct);

  LL_USART_DisableIT_CTS(USART1);
  LL_USART_DisableOverrunDetect(USART1);
  LL_USART_ConfigAsyncMode(USART1);
  LL_USART_Enable(USART1);
}

static void MX_GPIO_Init(void)
{
    LL_GPIO_InitTypeDef GPIO_InitStruct;
    LL_EXTI_InitTypeDef EXTI_InitStruct;
    LL_AHB1_GRP1_EnableClock(LL_AHB1_GRP1_PERIPH_GPIOC);
    LL_AHB1_GRP1_EnableClock(LL_AHB1_GRP1_PERIPH_GPIOA);
    LL_AHB1_GRP1_EnableClock(LL_AHB1_GRP1_PERIPH_GPIOB);
    LL_GPIO_ResetOutputPin(LED_GPIO_Port, LED_Pin);
    LL_GPIO_ResetOutputPin(IN1_GPIO_Port, IN1_Pin);
    LL_GPIO_ResetOutputPin(IN2_GPIO_Port, IN2_Pin);
    LL_GPIO_ResetOutputPin(IN4_GPIO_Port, IN4_Pin);
    LL_GPIO_ResetOutputPin(IN3_GPIO_Port, IN3_Pin);
    GPIO_InitStruct.Pin = CAL_Pin;
    GPIO_InitStruct.Mode = LL_GPIO_MODE_INPUT;
    GPIO_InitStruct.Pull = SET1_SET2_CL_CAL_PULL;
    LL_GPIO_Init(CAL_GPIO_Port, &GPIO_InitStruct);
    GPIO_InitStruct.Pin = CLOSE_Pin;
    GPIO_InitStruct.Mode = LL_GPIO_MODE_INPUT;
    GPIO_InitStruct.Pull = SET1_SET2_CL_CAL_PULL;
    LL_GPIO_Init(CLOSE_GPIO_Port, &GPIO_InitStruct);
    GPIO_InitStruct.Pin = SET2_Pin;
    GPIO_InitStruct.Mode = LL_GPIO_MODE_INPUT;
    GPIO_InitStruct.Pull = SET1_SET2_CL_CAL_PULL;
    LL_GPIO_Init(SET2_GPIO_Port, &GPIO_InitStruct);
    GPIO_InitStruct.Pin = SET1_Pin;
    GPIO_InitStruct.Mode = LL_GPIO_MODE_INPUT;
    GPIO_InitStruct.Pull = SET1_SET2_CL_CAL_PULL;
    LL_GPIO_Init(SET1_GPIO_Port, &GPIO_InitStruct);
    GPIO_InitStruct.Pin = LED_Pin;
    GPIO_InitStruct.Mode = LL_GPIO_MODE_OUTPUT;
    GPIO_InitStruct.Speed = LL_GPIO_SPEED_FREQ_HIGH;
    GPIO_InitStruct.OutputType = LL_GPIO_OUTPUT_PUSHPULL;
    GPIO_InitStruct.Pull = LL_GPIO_PULL_NO;
    LL_GPIO_Init(LED_GPIO_Port, &GPIO_InitStruct);
    GPIO_InitStruct.Pin = IN1_Pin;
    GPIO_InitStruct.Mode = LL_GPIO_MODE_OUTPUT;
    GPIO_InitStruct.Speed = LL_GPIO_SPEED_FREQ_HIGH;
    GPIO_InitStruct.OutputType = LL_GPIO_OUTPUT_PUSHPULL;
    GPIO_InitStruct.Pull = LL_GPIO_PULL_NO;
    LL_GPIO_Init(IN1_GPIO_Port, &GPIO_InitStruct);
    GPIO_InitStruct.Pin = IN2_Pin;
    GPIO_InitStruct.Mode = LL_GPIO_MODE_OUTPUT;
    GPIO_InitStruct.Speed = LL_GPIO_SPEED_FREQ_HIGH;
    GPIO_InitStruct.OutputType = LL_GPIO_OUTPUT_PUSHPULL;
    GPIO_InitStruct.Pull = LL_GPIO_PULL_NO;
    LL_GPIO_Init(IN2_GPIO_Port, &GPIO_InitStruct);
    GPIO_InitStruct.Pin = IN4_Pin;
    GPIO_InitStruct.Mode = LL_GPIO_MODE_OUTPUT;
    GPIO_InitStruct.Speed = LL_GPIO_SPEED_FREQ_HIGH;
    GPIO_InitStruct.OutputType = LL_GPIO_OUTPUT_PUSHPULL;
    GPIO_InitStruct.Pull = LL_GPIO_PULL_NO;
    LL_GPIO_Init(IN4_GPIO_Port, &GPIO_InitStruct);
    GPIO_InitStruct.Pin = IN3_Pin;
    GPIO_InitStruct.Mode = LL_GPIO_MODE_OUTPUT;
    GPIO_InitStruct.Speed = LL_GPIO_SPEED_FREQ_HIGH;
    GPIO_InitStruct.OutputType = LL_GPIO_OUTPUT_PUSHPULL;
    GPIO_InitStruct.Pull = LL_GPIO_PULL_NO;
    LL_GPIO_Init(IN3_GPIO_Port, &GPIO_InitStruct);
    GPIO_InitStruct.Pin = NSS_Pin;
    GPIO_InitStruct.Mode = LL_GPIO_MODE_OUTPUT;
    GPIO_InitStruct.Speed = LL_GPIO_SPEED_FREQ_HIGH;
    GPIO_InitStruct.OutputType = LL_GPIO_OUTPUT_PUSHPULL;
    GPIO_InitStruct.Pull = LL_GPIO_PULL_NO;
    LL_GPIO_Init(NSS_GPIO_Port, &GPIO_InitStruct);
    LL_SYSCFG_SetEXTISource(LL_SYSCFG_EXTI_PORTB, LL_SYSCFG_EXTI_LINE1);
    LL_SYSCFG_SetEXTISource(LL_SYSCFG_EXTI_PORTB, LL_SYSCFG_EXTI_LINE2);
    LL_GPIO_SetPinPull(DIRIN_GPIO_Port, DIRIN_Pin, LL_GPIO_PULL_NO);//方向控制信号外部管脚中断
    LL_GPIO_SetPinPull(ENIN_GPIO_Port, ENIN_Pin, LL_GPIO_PULL_UP);//使能信号外部管脚中断
    LL_GPIO_SetPinMode(DIRIN_GPIO_Port, DIRIN_Pin, LL_GPIO_MODE_INPUT);
    LL_GPIO_SetPinMode(ENIN_GPIO_Port, ENIN_Pin, LL_GPIO_MODE_INPUT);
    EXTI_InitStruct.Line_0_31 = LL_EXTI_LINE_1;
    EXTI_InitStruct.LineCommand = ENABLE;
    EXTI_InitStruct.Mode = LL_EXTI_MODE_IT;
    EXTI_InitStruct.Trigger = LL_EXTI_TRIGGER_RISING_FALLING;
    LL_EXTI_Init(&EXTI_InitStruct);
    EXTI_InitStruct.Line_0_31 = LL_EXTI_LINE_2;
    EXTI_InitStruct.LineCommand = ENABLE;
    EXTI_InitStruct.Mode = LL_EXTI_MODE_IT;
    EXTI_InitStruct.Trigger = LL_EXTI_TRIGGER_RISING_FALLING;
    LL_EXTI_Init(&EXTI_InitStruct);
    NVIC_SetPriority(EXTI0_1_IRQn, 0);
    NVIC_DisableIRQ(EXTI0_1_IRQn);
    NVIC_SetPriority(EXTI2_3_IRQn, 1);
    NVIC_DisableIRQ(EXTI2_3_IRQn);
}

void SetModeCheck(void)
{
    encoder_cnt = *(volatile uint16_t *)(ReadAngle() * 2 + FLASH_BASS_ADDRESS);
    if(CAL == LOW) //校正拨码开关ON进入编码器芯片校正程序
    {
        printf("进入校准模式\r\n");	
        CalibrateEncoder();
    }
    if((SET1 == HIGH) && (SET2 == HIGH)) //电子齿轮设置
    {
        printf("细分数4\r\n");
        stepangle = 20.48f;    //电机跑一圈需要的控制脉冲数为800
    }
    else if((SET1 == LOW) && (SET2 == HIGH))
    {
        printf("细分数8\r\n");
        stepangle = 10.24f;    //电机跑一圈需要的控制脉冲数为1600
    }
    else if((SET1 == HIGH) && (SET2 == LOW))
    {
        printf("细分数16\r\n");
        stepangle = 5.12f;    //电机跑一圈需要的控制脉冲数为3200
    }
    else
    {
        printf("细分数32\r\n");
        stepangle = 2.56f;    //电机跑一圈需要的控制脉冲数为6400
    }
    if(CLOSE == LOW)
    {
        printf("闭环模式\r\n");
        closedloop_mode = ENABLE;
    }
    else
    {
        printf("开环模式\r\n");
        closedloop_mode = DISABLE;
    }
    if(DIRIN == DIR_ACTIVE_LEVEL)
    {
        LL_TIM_SetCounterMode(TIM1, LL_TIM_COUNTERMODE_UP);
    }
    else
    {
        LL_TIM_SetCounterMode(TIM1, LL_TIM_COUNTERMODE_DOWN);
    }
    if(ENIN == EN_ACTIVE_LEVEL)
    {
        printf("电机使能\r\n");
        encoder_cnt = *(volatile uint16_t *)(ReadAngle() * 2 + FLASH_BASS_ADDRESS);
        step_input_sum = encoder_cnt;
        step_input = 0;
        step_input_last = 0;
        motor_pos_set = encoder_cnt;
        motor_pos_set_last = motor_pos_set;
        encoder_cnt_last = encoder_cnt;
        motor_pos = encoder_cnt;
        motor_pos_last = motor_pos;
        motor_rev_cnt = 0;
        LL_TIM_SetCounter(TIM1, 0);
        LL_TIM_EnableCounter(TIM1);
        en_mode = ENABLE;
    }
    else
    {
        LL_TIM_DisableCounter(TIM1);
        LL_TIM_OC_SetCompareCH1(TIM3, 0);
        LL_TIM_OC_SetCompareCH2(TIM3, 0);
        en_mode = DISABLE;
    }
    NVIC_EnableIRQ(EXTI0_1_IRQn);
    NVIC_EnableIRQ(EXTI2_3_IRQn);
}

void Output(int32_t theta, uint8_t effort)
{
    int16_t v_coil_A;
    int16_t v_coil_B;
    int16_t sin_coil_A;
    int16_t sin_coil_B;
    int16_t angle_1;
    int16_t angle_2;
    float phase_multiplier = 12.5f; //电机跑一圈共50个电相位角/4
    angle_1 = Mod(phase_multiplier * theta, 4096); //编码器读出的机械角转换为电相位角
    angle_2 = angle_1 + 1024;
    if(angle_2 > 4096)
    {
        angle_2 -= 4096;
    }
    sin_coil_A = sin_1[angle_1];
    sin_coil_B = sin_1[angle_2];
    v_coil_A = effort * sin_coil_A / 1024; //电机A相的矢量分解电流
    v_coil_B = effort * sin_coil_B / 1024; //电机B相的矢量分解电流
    if(v_coil_A >= 0)
    {
        LL_TIM_OC_SetCompareCH2(TIM3, v_coil_A);
        IN2_HIGH;
        IN1_LOW;
    }
    else
    {
        LL_TIM_OC_SetCompareCH2(TIM3, -v_coil_A);
        IN2_LOW;
        IN1_HIGH;
    }
    if(v_coil_B >= 0)
    {
        LL_TIM_OC_SetCompareCH1(TIM3, v_coil_B);
        IN3_HIGH;
        IN4_LOW;
    }
    else
    {
        LL_TIM_OC_SetCompareCH1(TIM3, -v_coil_B);
        IN3_LOW;
        IN4_HIGH;
    }
}
//电机走一整步1.8度函数
void OneStep(void)
{
    if(dir)
    {
        stepnumber += 1;
    }
    else
    {
        stepnumber -= 1;
    }
    Output((1.0 * ENCODER_CNT_PER_REV / MOTOR_STEPS_PER_REV) * stepnumber, CALIBRATION_MODE_CURRENT); //如果校正时电机太大把80的设置电机加到120左右或者更大些
    UsDelay(10);

}

void OneStep_4096(void)
{
    if(dir)
    {
        stepnumber += 1;
    }
    else
    {
        stepnumber -= 1;
    }
    Output((1.0 * ENCODER_CNT_PER_REV / 4096) * stepnumber, CALIBRATION_MODE_CURRENT); //如果校正时电机太大把80的设置电机加到120左右或者更大些
    UsDelay(10);
}

void test_4096(void)
{
	uint16_t i;
	
	dir = 0;
	for(i=0;i<40960;i++)
	{
		OneStep_4096();
	}
	dir = !dir;
	for(i=0;i<40960;i++)
	{
		OneStep_4096();
	}
	dir = !dir;	
		for(i=0;i<40960;i++)
	{
		OneStep_4096();
	}
	dir = !dir;
	for(i=0;i<40960;i++)
	{
		OneStep_4096();
	}
	
}

//求模函数
int16_t Mod(int32_t xMod, int16_t mMod)
{
    int16_t temp;
    temp = xMod % mMod;
    if(temp < 0)
    {
        return (temp + mMod);
    }
    else
    {
        return  temp;
    }
}

void UsDelay(uint16_t us)
{
    us *= 10;
    while(us)
    {
        __NOP();
        __NOP();
        us--;
    }
}
//单片机FLASH解锁
void FlashUnlock(void)
{
    FLASH->KEYR = FLASH_KEY1;
    FLASH->KEYR = FLASH_KEY2;
}
//单片机FLASH加锁
void FlashLock(void)
{
    FLASH->CR |= 1 << 7;
}

uint8_t FlashGetStatus(void)
{
    uint32_t res;
    res = FLASH->SR;
    if(res & (1 << 0))
    {
        return 1;
    }
    else if(res & (1 << 2))
    {
        return 2;
    }
    else if(res & (1 << 4))
    {
        return 3;
    }
    return 0;
}

uint8_t FlashWaitDone(uint16_t time)
{
    uint8_t res;
    do
    {
        res = FlashGetStatus();
        if(res != 1)
        {
            break;
        }
        UsDelay(1);
        time--;
    }
    while(time);
    if(time == 0)
    {
        res = 0xff;
    }
    return res;
}
//单片机FLASH擦除一页
uint8_t FlashErasePage(uint32_t paddr)
{
    uint8_t res = 0;
    res = FlashWaitDone(0X5FFF);
    if(res == 0)
    {
        FLASH->CR |= 1 << 1;
        FLASH->AR = paddr;
        FLASH->CR |= 1 << 6;
        res = FlashWaitDone(0X5FFF);
        if(res != 1)
        {
            FLASH->CR &= ~(1 << 1);
        }
    }
    return res;
}
//单片机FLASH擦除后32K
void FlashErase32K(void)
{
    for(int i = 0; i < 32; i++)
    {
        FlashErasePage(FLASH_BASS_ADDRESS + i * 0x400);
    }
}
//单片机FLASH写16位
uint8_t FlashWriteHalfWord(uint32_t faddr, uint16_t dat)
{
    uint8_t  res;
    res = FlashWaitDone(0XFF);
    if(res == 0)
    {
        FLASH->CR |= 1 << 0;
        *(volatile uint16_t *)faddr = dat;
        res = FlashWaitDone(0XFF);
        if(res != 1)
        {
            FLASH->CR &= ~(1 << 0);
        }
    }
    return res;
}
//单片机FLASH读16位
uint16_t FlashReadHalfWord(uint32_t faddr)
{
    return *(volatile uint16_t *)faddr;
}
//STDIO.H串口输出重载函数
int fputc(int c, FILE * stream)
{
    LL_USART_TransmitData8(USART1, c);
    while(!LL_USART_IsActiveFlag_TXE(USART1)) { __NOP(); }
    LL_USART_ClearFlag_TC(USART1);
    return c;
}
//STDIO.H串口输入重载函数
int fgetc(FILE * stream)
{
    while(!LL_USART_IsActiveFlag_RXNE(USART1)) { __NOP(); }
    return ((char)LL_USART_ReceiveData8(USART1));
}
//简单的ASICC控制协议，可以直接使用printf和scanf函数进行扩展
void SerialCheck(void)
{
    char command[64];
    int temp1;
    int temp2;
    int temp3;
    printf("----- HyperStepper 20190829 -----\r\n");
    printf("PID gains: kp =%d, ki =%d, kd =%d\r\n", kp, ki, kd);
    printf("Please input your command\r\n");
    while(1)
    {
        scanf("%s", command);
        printf(">>%s\r\n", command);
        if(strstr(command, "kp=") != NULL)
        {
            sscanf(command, "kp=%d,ki=%d,kd=%d", &temp1, &temp2, &temp3);
            kp = temp1;
            ki = temp2;
            kd = temp3;
            printf("<<kp = %d\r\n", kp);
            printf("<<ki = %d\r\n", ki);
            printf("<<kd = %d\r\n", kd);
        }
    }
}

uint16_t ReadValue(uint16_t RegAdd)
{
  uint16_t data;
  NSS_L;
  while(LL_SPI_IsActiveFlag_TXE(SPI1)==0);
  LL_SPI_TransmitData16(SPI1,RegAdd);
  while(LL_SPI_IsActiveFlag_RXNE(SPI1)==0);
  data=LL_SPI_ReceiveData16(SPI1);
  SPI_TX_OD;
  while(LL_SPI_IsActiveFlag_TXE(SPI1)==0);
  LL_SPI_TransmitData16(SPI1,0xFFFF);
  while(LL_SPI_IsActiveFlag_RXNE(SPI1)==0);
  data=LL_SPI_ReceiveData16(SPI1)&0x7FFF;
  NSS_H;
  SPI_TX_PP;
  return data;
}

void WriteValue(uint16_t RegAdd,uint16_t RegValue)
{
  uint16_t data;
  NSS_L;
  while(LL_SPI_IsActiveFlag_TXE(SPI1)==0);
  LL_SPI_TransmitData16(SPI1,RegAdd);
  while(LL_SPI_IsActiveFlag_RXNE(SPI1)==0);
  data=LL_SPI_ReceiveData16(SPI1);
  while(LL_SPI_IsActiveFlag_TXE(SPI1)==0);
  LL_SPI_TransmitData16(SPI1,RegValue);
  while(LL_SPI_IsActiveFlag_RXNE(SPI1)==0);
  data=LL_SPI_ReceiveData16(SPI1);
  NSS_H;
}

uint16_t ReadState(void)
{
  return (ReadValue(READ_STATUS));
}

uint16_t ReadAngle(void)
{
  return (ReadValue(READ_ANGLE_VALUE)>>1);
}


//编码器校正函数
void CalibrateEncoder(void)
{
    int32_t encoderReading = 0;
    int32_t currentencoderReading = 0;
    int32_t lastencoderReading = 0;
    int32_t iStart = 0;
    int32_t jStart = 0;
    int32_t stepNo = 0;
    int32_t fullStepReadings[MOTOR_STEPS_PER_REV];//一圈200整步的编码器值数组
    int32_t ticks = 0;
    uint32_t address = FLASH_BASS_ADDRESS; //写入FLASH的起使地址
    uint16_t lookupAngle;

    dir = 1;
    Output(0, CALIBRATION_MODE_CURRENT); //开始时固定在整步位置，如果校正时电机太大把80的设置电机加到120左右或者更大些
    for(uint8_t m = 0; m < 4; m++)
    {
        LED_H;
        LL_mDelay(250);
        LED_L;
        LL_mDelay(250);
    }
    for(int16_t x = 0; x < MOTOR_STEPS_PER_REV; x++) //逆时针跑一圈记下各整步位的值
    {
        encoderReading = 0;
        lastencoderReading = ReadAngle();
        for(uint8_t reading = 0; reading < 10; reading++)
        {
            currentencoderReading = ReadAngle();
            if(currentencoderReading - lastencoderReading < -(ENCODER_CNT_PER_REV / 2))
            {
                currentencoderReading += ENCODER_CNT_PER_REV;
            }
            else if(currentencoderReading - lastencoderReading > (ENCODER_CNT_PER_REV / 2))
            {
                currentencoderReading -= ENCODER_CNT_PER_REV;
            }
            encoderReading += currentencoderReading;
            LL_mDelay(1);
            lastencoderReading = currentencoderReading;
        }
        encoderReading = encoderReading / 10;
        if(encoderReading > ENCODER_CNT_PER_REV)
        {
            encoderReading -= ENCODER_CNT_PER_REV;
        }
        else if(encoderReading < 0)
        {
            encoderReading += ENCODER_CNT_PER_REV;
        }
        fullStepReadings[x] = encoderReading;
        OneStep();
    }
    dir = 0;
    OneStep();
    LL_mDelay(1000);
    for(int16_t x = (MOTOR_STEPS_PER_REV - 1); x >= 0; x--) //顺时针跑一圈记下各整步位的值和之前逆时针保存的值求平均
    {
        encoderReading = 0;
        lastencoderReading = ReadAngle();
        for(uint8_t reading = 0; reading < 10; reading++)
        {
            currentencoderReading = ReadAngle();
            if(currentencoderReading - lastencoderReading < -(ENCODER_CNT_PER_REV / 2))
            {
                currentencoderReading += ENCODER_CNT_PER_REV;
            }
            else if(currentencoderReading - lastencoderReading > (ENCODER_CNT_PER_REV / 2))
            {
                currentencoderReading -= ENCODER_CNT_PER_REV;
            }
            encoderReading += currentencoderReading;
            LL_mDelay(1);
            lastencoderReading = currentencoderReading;
        }
        encoderReading = encoderReading / 10;
        if(encoderReading > ENCODER_CNT_PER_REV)
        {
            encoderReading -= ENCODER_CNT_PER_REV;
        }
        else if(encoderReading < 0)
        {
            encoderReading += ENCODER_CNT_PER_REV;
        }	
		if(my_abs(fullStepReadings[x] - encoderReading) > ENCODER_CNT_PER_REV*0.9)//0点回差
		{			
			encoderReading = fullStepReadings[x];			
		}	
        fullStepReadings[x] = (fullStepReadings[x] + encoderReading) / 2;
		printf("read[x]:%d\n",fullStepReadings[x]);
        OneStep();
    }
    LL_TIM_OC_SetCompareCH1(TIM3, 0);
    LL_TIM_OC_SetCompareCH2(TIM3, 0);
    for(uint8_t i = 0; i < MOTOR_STEPS_PER_REV; i++) //算出200整步间的插值数
    {
        ticks = fullStepReadings[(i + 1) % MOTOR_STEPS_PER_REV] - fullStepReadings[i % MOTOR_STEPS_PER_REV];
        if(ticks < -(ENCODER_CNT_PER_REV * 0.9))//跨零点
        {
            ticks += ENCODER_CNT_PER_REV;
        }
        else if(ticks > (ENCODER_CNT_PER_REV * 0.9))//跨零点
        {
            ticks -= ENCODER_CNT_PER_REV;
        }

        for(int32_t j = 0; j < ticks; j++)
        {
            stepNo = (fullStepReadings[i] + j) % ENCODER_CNT_PER_REV;
            if(stepNo == 0)
            {
                iStart = i;
                jStart = j;
				break;
            }
        }
    }
    FlashUnlock();
    FlashErase32K();
    for(int32_t i = iStart; i < (iStart + MOTOR_STEPS_PER_REV + 1); i++) //以步进电机整步为基准（小于0.08度）开始对编码器进行校正插值并将校正后的值存入FLASH
    {
        ticks = fullStepReadings[(i + 1) % MOTOR_STEPS_PER_REV] - fullStepReadings[i % MOTOR_STEPS_PER_REV];
        if(ticks < -(ENCODER_CNT_PER_REV * 0.9))
        {
            ticks += ENCODER_CNT_PER_REV;
        }
        if(i == iStart)
        {
            for(int32_t j = jStart; j < ticks; j++)
            {
                lookupAngle = ((ENCODER_CNT_PER_REV / 2) * i + (ENCODER_CNT_PER_REV / 2) * j / ticks) % (ENCODER_CNT_PER_REV * 100) / 100;
                FlashWriteHalfWord(address, (uint16_t)lookupAngle);
                address += 2;
            }
        }
        else if(i == (iStart + MOTOR_STEPS_PER_REV))
        {
            for(int32_t j = 0; j < jStart; j++)
            {
                lookupAngle = (((ENCODER_CNT_PER_REV / 2) * i + (ENCODER_CNT_PER_REV / 2) * j / ticks) % (ENCODER_CNT_PER_REV * 100)) / 100;
                FlashWriteHalfWord(address, (uint16_t)lookupAngle);
                address += 2;
            }
        }
        else
        {
            //this is the general case
            for(int32_t j = 0; j < ticks; j++)
            {
                lookupAngle = (((ENCODER_CNT_PER_REV / 2) * i + (ENCODER_CNT_PER_REV / 2) * j / ticks) % (ENCODER_CNT_PER_REV * 100)) / 100;
                FlashWriteHalfWord(address, (uint16_t)lookupAngle);
                address += 2;
            }
        }
    }
    FlashLock();
    while(1)
    {
        LED_H;
        LL_mDelay(250);
        LED_L;
        LL_mDelay(250);
    }
}

void _Error_Handler(char * file, int line)
{
    /* USER CODE BEGIN Error_Handler_Debug */
    /* User can add his own implementation to report the HAL error return state */
    while(1)
    {
    }
    /* USER CODE END Error_Handler_Debug */
}

#ifdef  USE_FULL_ASSERT

void assert_failed(uint8_t * file, uint32_t line)
{
    /* USER CODE BEGIN 6 */
    /*  User can add his own implementation to report the file name and line number,
        tex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
    /* USER CODE END 6 */
}
#endif /* USE_FULL_ASSERT */

/**
    @}
*/

/**
    @}
*/

